# Authentication System

This document explains the authentication system for WormWarden, which solves the problem of manually managing Pathfinder session cookies.

## Problem

Previously, the bot required manual setup of Pathfinder session cookies:
- `PF_SESSION` - Pathfinder session cookie
- `PF_CHAR_COOKIE` - Character-specific cookie
- `PF_CHARACTER` - Character ID

These cookies would expire and require manual renewal by logging into Pathfinder and copying the values.

## Solution

The new authentication system uses EVE Online's SSO (Single Sign-On) API to automatically authenticate with both EVE Online and Pathfinder.

### How It Works

1. **EVE SSO Authentication**: Uses EVE Online's OAuth 2.0 flow
2. **Token Management**: Automatically refreshes access tokens
3. **Pathfinder Integration**: Uses EVE tokens to authenticate with Pathfinder
4. **Backward Compatibility**: Still supports manual session cookies as fallback

## Setup Instructions

### 1. Get EVE Developer Credentials

1. Go to https://developers.eveonline.com/
2. Create a new application
3. Set the callback URL to: `http://localhost:8080/callback`
4. Copy the Client ID and Client Secret

### 2. Configure Environment Variables

Create a `.env` file with:

```env
# Required for EVE SSO
EVE_CLIENT_ID=your_client_id_here
EVE_CLIENT_SECRET=your_client_secret_here
EVE_CALLBACK_URL=http://localhost:8080/callback

# Optional: Custom Pathfinder URL
PATHFINDER_URL=https://path.shadowflight.org

# Bot Configuration
MAP_ID=1
DISCORD_WEBHOOK=https://discord.com/api/webhooks/...
```

### 3. Run Authentication Setup

```bash
python3 setup_auth.py
```

This will:
1. Open your browser for EVE SSO authentication
2. Handle the OAuth callback
3. Store tokens securely
4. Test the authentication

### 4. Test Authentication

```bash
python3 test_auth.py
```

## File Structure

```
helpers/
├── auth.py          # EVE SSO and Pathfinder authentication
├── pathfinder.py    # Updated to use new auth system
└── data.py          # Data persistence (unchanged)

setup_auth.py        # Interactive setup script
test_auth.py         # Authentication test script
eve_tokens.json      # Stored tokens (auto-generated)
```

## Token Management

### Storage
- Tokens are stored in `eve_tokens.json`
- This file is automatically generated and managed
- Added to `.gitignore` for security

### Automatic Refresh
- Access tokens expire after 20 minutes
- Refresh tokens are valid for much longer
- The system automatically refreshes tokens before they expire
- No manual intervention required

### Security
- Tokens are stored locally only
- No tokens are logged or displayed
- Refresh tokens are used securely

## Backward Compatibility

The system maintains backward compatibility with manual session cookies:

```env
# Legacy method (still works)
PF_SESSION=your_session_cookie
PF_CHAR_COOKIE=your_char_cookie
PF_CHARACTER=your_character_id
```

If EVE SSO authentication fails, the system falls back to manual cookies.

## Troubleshooting

### Common Issues

1. **"No valid authentication found"**
   - Run `python3 setup_auth.py`
   - Check your `.env` file has correct EVE credentials

2. **"EVE authentication failed"**
   - Verify your Client ID and Secret are correct
   - Check that the callback URL matches your EVE app settings

3. **"Pathfinder authentication failed"**
   - EVE authentication works but Pathfinder integration fails
   - This may be due to Pathfinder-specific configuration
   - Manual cookies can still be used as fallback

4. **"Could not open browser automatically"**
   - Manually open the URL shown in the terminal
   - Complete the authentication flow in your browser

### Debug Mode

To see detailed authentication information, you can modify the auth classes to include debug logging.

## API Reference

### EVEAuth Class

```python
from helpers.auth import EVEAuth

auth = EVEAuth()

# Check if authenticated
if auth.is_authenticated():
    print("✅ Authenticated")

# Get character info
char_info = auth.get_character_info()

# Manually refresh tokens
auth.refresh_access_token()
```

### PathfinderClient Class

```python
from helpers.pathfinder import PathfinderClient

client = PathfinderClient()

# Get map data with automatic auth
data = client.get_map_data()

# Check authentication status
if client._ensure_authenticated():
    print("✅ Ready to fetch data")
```

## Migration from Manual Cookies

If you're currently using manual session cookies:

1. **Keep your current setup working** - The system is backward compatible
2. **Set up EVE SSO** - Follow the setup instructions above
3. **Test the new system** - Run `python3 test_auth.py`
4. **Switch over** - Once confirmed working, you can remove manual cookies from `.env`

The bot will automatically use the best available authentication method. 